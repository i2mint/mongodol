
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mongodol.base &#8212; mongodol 0.0.4 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mongodol.base</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">KeysView</span><span class="p">,</span> <span class="n">ValuesView</span><span class="p">,</span> <span class="n">ItemsView</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>

<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>

<span class="kn">from</span> <span class="nn">dol</span> <span class="kn">import</span> <span class="n">KvReader</span>
<span class="kn">from</span> <span class="nn">dol</span> <span class="kn">import</span> <span class="n">Collection</span> <span class="k">as</span> <span class="n">DolCollection</span>

<span class="kn">from</span> <span class="nn">mongodol.constants</span> <span class="kn">import</span> <span class="n">ID</span><span class="p">,</span> <span class="n">PyMongoCollectionSpec</span><span class="p">,</span> <span class="n">end_of_cursor</span><span class="p">,</span> <span class="n">DFLT_TEST_DB</span>
<span class="kn">from</span> <span class="nn">mongodol.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProjectionSpec</span><span class="p">,</span>
    <span class="n">normalize_projection</span><span class="p">,</span>
    <span class="n">projection_union</span><span class="p">,</span>
    <span class="n">get_mongo_collection_pymongo_obj</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># TODO: mgc type annotation</span>
<span class="c1">#  See https://stackoverflow.com/questions/66464191/referencing-a-python-class-within-its-definition-but-outside-a-method</span>
<div class="viewcode-block" id="MongoCollectionCollection"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionCollection">[docs]</a><span class="k">class</span> <span class="nc">MongoCollectionCollection</span><span class="p">(</span><span class="n">DolCollection</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mgc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PyMongoCollectionSpec</span><span class="p">,</span> <span class="n">DolCollection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">iter_projection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span> <span class="o">=</span> <span class="n">get_mongo_collection_pymongo_obj</span><span class="p">(</span><span class="n">mgc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span> <span class="o">=</span> <span class="n">iter_projection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mgc_find_kwargs</span> <span class="o">=</span> <span class="n">mgc_find_kwargs</span>

    <span class="k">def</span> <span class="nf">_merge_with_filt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args: dictionaries that are valid mongo queries</span>
<span class="sd">        :return:</span>

<span class="sd">        &gt;&gt;&gt; class Mock(MongoCollectionCollection):</span>
<span class="sd">        ...     def __init__(self, filter):</span>
<span class="sd">        ...         self.filter = filter</span>
<span class="sd">        &gt;&gt;&gt; s = Mock(filter={&#39;a&#39;: 3, &#39;b&#39;: {&#39;$in&#39;: [1, 2, 3]}})</span>
<span class="sd">        &gt;&gt;&gt; s._merge_with_filt({&#39;c&#39;: &#39;me&#39;})</span>
<span class="sd">        {&#39;$and&#39;: [{&#39;a&#39;: 3, &#39;b&#39;: {&#39;$in&#39;: [1, 2, 3]}}, {&#39;c&#39;: &#39;me&#39;}]}</span>
<span class="sd">        &gt;&gt;&gt; s._merge_with_filt({&#39;b&#39;: 4})</span>
<span class="sd">        {&#39;$and&#39;: [{&#39;a&#39;: 3, &#39;b&#39;: {&#39;$in&#39;: [1, 2, 3]}}, {&#39;b&#39;: 4}]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return {&quot;$and&quot;: [self.filter, *args]}  # in case we want to move to handling several elements to merge</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;$and&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">m</span><span class="p">]}</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_mgc_find_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_count_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">projection</span><span class="o">=</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">end_of_cursor</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">end_of_cursor</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_count_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">search_map</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mgc_find_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">search_map</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;skip&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;hint&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">search_map</span>
        <span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">mgc_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(mgc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mgc_repr</span><span class="si">}</span><span class="s1">, filter=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="si">}</span><span class="s1">, iter_projection=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgc_find_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<span class="k">class</span> <span class="nc">MongoValuesView</span><span class="p">(</span><span class="n">ValuesView</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">projection</span><span class="o">=</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">end_of_cursor</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">end_of_cursor</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">_getitem_projection</span><span class="p">)</span>

    <span class="c1"># def distinct(self, key, filter=None, **kwargs):</span>
    <span class="c1">#     m = self._mapping</span>
    <span class="c1">#     # TODO: Check if this is correct (what about $ cases?): filter=m._merge_with_filt(filter)</span>
    <span class="c1">#     return m.mgc.distinct(key, filter=m._merge_with_filt(filter), **kwargs)</span>
    <span class="c1">#</span>
    <span class="c1"># unique = distinct</span>


<div class="viewcode-block" id="MongoItemsView"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoItemsView">[docs]</a><span class="k">class</span> <span class="nc">MongoItemsView</span><span class="p">(</span><span class="n">ItemsView</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">item</span>
        <span class="c1"># TODO: How do we have cursor return no data (here still has _id)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">m</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">k</span><span class="p">)),</span> <span class="n">projection</span><span class="o">=</span><span class="p">())</span>
        <span class="c1"># return cursor</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">end_of_cursor</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">end_of_cursor</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">_items_projection</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">key_fields</span><span class="p">}</span>
            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">doc</span></div>


<div class="viewcode-block" id="MongoCollectionReader"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionReader">[docs]</a><span class="k">class</span> <span class="nc">MongoCollectionReader</span><span class="p">(</span><span class="n">MongoCollectionCollection</span><span class="p">,</span> <span class="n">KvReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class to read from a mongo collection, or subset thereof, with the Mapping (i.e. dict-like) interface.</span>

<span class="sd">    Some examples below. For examples using actual data (with setup and tear down) see the tests/ folder.</span>

<span class="sd">    &gt;&gt;&gt; from pymongo import MongoClient</span>
<span class="sd">    &gt;&gt;&gt; s = MongoCollectionReader(MongoClient()[&#39;mongodol&#39;][&#39;mongodol_test&#39;])</span>
<span class="sd">    &gt;&gt;&gt; list_of_keys = list(s)</span>
<span class="sd">    &gt;&gt;&gt; fake_key = {&#39;_id&#39;: &#39;this key does not exist&#39;}</span>
<span class="sd">    &gt;&gt;&gt; fake_key in s</span>
<span class="sd">    False</span>

<span class="sd">    It&#39;s important to note that ``s[k]`` (for any base MongoCollectionReader instance ``s``) returns a Cursor,</span>
<span class="sd">    and will always return a Cursor, no matter what key ``k`` you ask for</span>
<span class="sd">    -- as long as the key is a valid mapping (dict usually).</span>
<span class="sd">    This cursor is a (pymongo) object that is used to iterate over the results of the ``k`` lookup.</span>
<span class="sd">    It may yield no results what-so-ever, or one, or many.</span>

<span class="sd">    &gt;&gt;&gt; v = s[fake_key]</span>
<span class="sd">    &gt;&gt;&gt; type(v).__name__</span>
<span class="sd">    &#39;Cursor&#39;</span>
<span class="sd">    &gt;&gt;&gt; len(list(v))  # but the cursor yields no results</span>
<span class="sd">    0</span>

<span class="sd">    Indeed, ``MongoCollectionReader`` is really meant to provide a low level key-value interface to a mongo collection</span>
<span class="sd">    that is really meant to be wrapped in order to produce the actual key-value interfaces one needs.</span>
<span class="sd">    You shouldn&#39;t think of it&#39;s instances as a normal dict where any request for the value under a key,</span>
<span class="sd">    for a key that doesn&#39;t exist, will result in a ``KeyError``.</span>
<span class="sd">    Note that this means that `s.get(k, default)` will never result in the default being returned,</span>
<span class="sd">    since there are no missing keys here; only empty results (cursors that don&#39;t yield anything).</span>

<span class="sd">    &gt;&gt;&gt; v = s.get(fake_key, {&#39;the&#39;: &#39;default&#39;})</span>
<span class="sd">    &gt;&gt;&gt; assert v != {&#39;the&#39;: &#39;default&#39;}</span>

<span class="sd">    ``s.keys()``, ``s.values()``, and ``s.items()`` are ``collections.abc.MappingViews`` instances</span>
<span class="sd">    (specialized for mongo).</span>

<span class="sd">    &gt;&gt;&gt; type(s.keys()).__name__</span>
<span class="sd">    &#39;KeysView&#39;</span>
<span class="sd">    &gt;&gt;&gt; type(s.values()).__name__</span>
<span class="sd">    &#39;MongoValuesView&#39;</span>
<span class="sd">    &gt;&gt;&gt; type(s.items()).__name__</span>
<span class="sd">    &#39;MongoItemsView&#39;</span>

<span class="sd">    Recall that ``collections.abc.MappingViews`` have many set-like functionalities:</span>

<span class="sd">    &gt;&gt;&gt; fake_key in s.keys()</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; a_list_of_fake_keys = [{&#39;_id&#39;: &#39;fake_key&#39;}, {&#39;_id&#39;: &#39;yet_another&#39;}]</span>
<span class="sd">    &gt;&gt;&gt; s.keys().isdisjoint(a_list_of_fake_keys)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s.keys() &amp; a_list_of_fake_keys</span>
<span class="sd">    set()</span>
<span class="sd">    &gt;&gt;&gt; fake_value = {&#39;data&#39;: &quot;this does not exist&quot;}</span>
<span class="sd">    &gt;&gt;&gt; fake_value in s.values()</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; fake_item = (fake_key, fake_value)</span>
<span class="sd">    &gt;&gt;&gt; fake_item in s.items()</span>
<span class="sd">    False</span>

<span class="sd">    Note though that since keys and values are both dictionaries in mongo, some of these set-like functionalities</span>
<span class="sd">    might not work (complaints such as ``TypeError: unhashable type: &#39;dict&#39;``),</span>
<span class="sd">    such as:</span>

<span class="sd">    &gt;&gt;&gt; s.keys() | a_list_of_fake_keys</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    TypeError: unhashable type: &#39;dict&#39;</span>

<span class="sd">    But you can take care of that in higher level wrappers that have hashable keys and/or values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_projections_are_flattened</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_wrap_for_method</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">MongoValuesView</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">MongoItemsView</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mgc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PyMongoCollectionSpec</span><span class="p">,</span> <span class="n">KvReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">iter_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ID</span><span class="p">,),</span>
        <span class="n">getitem_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_projection</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">iter_projection</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">iter_projection</span><span class="p">}</span>
        <span class="k">assert</span> <span class="n">iter_projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;iter_projection cannot be None&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mgc</span><span class="o">=</span><span class="n">mgc</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="n">iter_projection</span><span class="o">=</span><span class="n">iter_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_projection</span> <span class="o">=</span> <span class="n">getitem_projection</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">Mapping</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;k (key) must be a mapping (typically a dictionary). Was:</span><span class="se">\n\t</span><span class="s1">k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem_projection</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MongoCollectionReader.keys"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionReader.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KeysView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="MongoCollectionReader.values"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionReader.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MongoValuesView</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MongoValuesView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_items_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iter_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span>
        <span class="n">getitem_projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_projection</span>
        <span class="k">if</span> <span class="n">iter_projection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">getitem_projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">iter_projection</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">iter_projection</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">projection_union</span><span class="p">(</span>
            <span class="n">iter_projection</span><span class="p">,</span>
            <span class="n">getitem_projection</span><span class="p">,</span>
            <span class="n">already_flattened</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_projections_are_flattened</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">key_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_iter_projection</span> <span class="o">=</span> <span class="n">normalize_projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_projection</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">_iter_projection</span> <span class="k">if</span> <span class="n">_iter_projection</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">val_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_getitem_projection</span> <span class="o">=</span> <span class="n">normalize_projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem_projection</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">_getitem_projection</span>
                <span class="k">if</span> <span class="n">_getitem_projection</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">)</span>

<div class="viewcode-block" id="MongoCollectionReader.items"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionReader.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MongoItemsView</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MongoItemsView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_params</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DFLT_TEST_DB</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="n">mongo_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">iter_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ID</span><span class="p">,),</span>
        <span class="n">getitem_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">mongo_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mongo_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mongo_client</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">mongo_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="o">**</span><span class="n">mongo_client</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">mgc</span><span class="o">=</span><span class="n">mongo_client</span><span class="p">[</span><span class="n">db_name</span><span class="p">][</span><span class="n">collection_name</span><span class="p">],</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">iter_projection</span><span class="o">=</span><span class="n">iter_projection</span><span class="p">,</span>
            <span class="n">getitem_projection</span><span class="o">=</span><span class="n">getitem_projection</span><span class="p">,</span>
            <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO: Check if this is correct (what about $ cases?): filter=m._merge_with_filt(filter)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="nb">filter</span> <span class="ow">or</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="n">unique</span> <span class="o">=</span> <span class="n">distinct</span>

    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_pipeline</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">_pipeline</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MongoCollectionFieldsReader"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionFieldsReader">[docs]</a><span class="k">class</span> <span class="nc">MongoCollectionFieldsReader</span><span class="p">(</span><span class="n">MongoCollectionReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class to read from a mongo collection, or subset thereof, with the Mapping (i.e. dict-like) interface.</span>

<span class="sd">    An &quot;easier&quot; interface for the common case where we just want to specify fixed fields for keys and vals.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_projections_are_flattened</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mgc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PyMongoCollectionSpec</span><span class="p">,</span> <span class="n">KvReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key_fields</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ID</span><span class="p">,),</span>
        <span class="n">val_fields</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">iter_projection</span> <span class="o">=</span> <span class="n">normalize_projection</span><span class="p">(</span><span class="n">key_fields</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mgc</span><span class="o">=</span><span class="n">mgc</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">iter_projection</span><span class="o">=</span><span class="n">normalize_projection</span><span class="p">(</span><span class="n">key_fields</span><span class="p">),</span>
            <span class="n">getitem_projection</span><span class="o">=</span><span class="n">normalize_projection</span><span class="p">(</span><span class="n">val_fields</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_fields</span> <span class="o">=</span> <span class="n">key_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_fields</span> <span class="o">=</span> <span class="n">val_fields</span></div>


<div class="viewcode-block" id="MongoCollectionPersister"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoCollectionPersister">[docs]</a><span class="k">class</span> <span class="nc">MongoCollectionPersister</span><span class="p">(</span><span class="n">MongoCollectionReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;base class to read from and write to a mongo collection, or subset thereof, with the MutableMapping interface.</span>

<span class="sd">    &gt;&gt;&gt; from mongodol.util import mk_dflt_mgc</span>
<span class="sd">    &gt;&gt;&gt; mongo_collection_obj = mk_dflt_mgc()</span>
<span class="sd">    &gt;&gt;&gt; s = MongoCollectionPersister(mongo_collection_obj, getitem_projection={&#39;_id&#39;: False})</span>
<span class="sd">    &gt;&gt;&gt; for k in s:  # deleting all docs in default collection</span>
<span class="sd">    ...     del s[k]</span>
<span class="sd">    &gt;&gt;&gt; k = {&#39;_id&#39;: &#39;foo&#39;}</span>
<span class="sd">    &gt;&gt;&gt; v = {&#39;val&#39;: &#39;bar&#39;}</span>
<span class="sd">    &gt;&gt;&gt; k in s  # see that key is not in store (and testing __contains__)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; len(s)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; s[k] = v</span>
<span class="sd">    &gt;&gt;&gt; len(s)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; list(s)</span>
<span class="sd">    [{&#39;_id&#39;: &#39;foo&#39;}]</span>

<span class="sd">    Since this is a base mongo store, the values are cursors, so to get an actual value, you need to fetch the first doc</span>

<span class="sd">    &gt;&gt;&gt; next(s[k])</span>
<span class="sd">    {&#39;val&#39;: &#39;bar&#39;}</span>
<span class="sd">    &gt;&gt;&gt; next(s.get(k))</span>
<span class="sd">    {&#39;val&#39;: &#39;bar&#39;}</span>

<span class="sd">    Remember (see ``MongoCollectionReader`` docs) that ``s.get`` will never reach its default since</span>
<span class="sd">    the reader will always return a cursor (possibly empty).</span>
<span class="sd">    So in the following case, we should get an empty cursor (not a default value)</span>

<span class="sd">    &gt;&gt;&gt; list(s.get({&#39;not&#39;: &#39;a key&#39;}, {&#39;default&#39;: &#39;val&#39;}))  # testing s.get with default</span>
<span class="sd">    []</span>


<span class="sd">    &gt;&gt;&gt; list(s.values())</span>
<span class="sd">    [{&#39;val&#39;: &#39;bar&#39;}]</span>
<span class="sd">    &gt;&gt;&gt; k in s  # testing __contains__ again</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; k in s.keys()  # test the contains capability of s.keys() (a MongoKeysView instance)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; del s[k]</span>
<span class="sd">    &gt;&gt;&gt; len(s)</span>
<span class="sd">    0</span>

<span class="sd">    &gt;&gt;&gt; # Making a persister whose keys are 2-dimensional and values are 3-dimensional</span>
<span class="sd">    &gt;&gt;&gt; from mongodol.util import normalize_projection</span>
<span class="sd">    &gt;&gt;&gt; s = MongoCollectionPersister(mongo_collection_obj,</span>
<span class="sd">    ...                     iter_projection={&#39;first&#39;: True, &#39;last&#39;: True, &#39;_id&#39;: False},</span>
<span class="sd">    ...                     getitem_projection=normalize_projection((&#39;yob&#39;, &#39;proj&#39;, &#39;bdfl&#39;)))</span>
<span class="sd">    &gt;&gt;&gt; for _id in s:  # deleting all docs in tmp</span>
<span class="sd">    ...     del s[_id]</span>
<span class="sd">    &gt;&gt;&gt; # writing two items</span>
<span class="sd">    &gt;&gt;&gt; s[{&#39;first&#39;: &#39;Guido&#39;, &#39;last&#39;: &#39;van Rossum&#39;}] = {&#39;yob&#39;: 1956, &#39;proj&#39;: &#39;python&#39;, &#39;bdfl&#39;: False}</span>
<span class="sd">    &gt;&gt;&gt; s[{&#39;first&#39;: &#39;Vitalik&#39;, &#39;last&#39;: &#39;Buterin&#39;}] = {&#39;yob&#39;: 1994, &#39;proj&#39;: &#39;ethereum&#39;, &#39;bdfl&#39;: True}</span>
<span class="sd">    &gt;&gt;&gt; # Seeing that those two items are there</span>
<span class="sd">    &gt;&gt;&gt; for key, val in s.items():</span>
<span class="sd">    ...     print(f&quot;{key} --&gt; {val}&quot;)</span>
<span class="sd">    {&#39;first&#39;: &#39;Guido&#39;, &#39;last&#39;: &#39;van Rossum&#39;} --&gt; {&#39;yob&#39;: 1956, &#39;proj&#39;: &#39;python&#39;, &#39;bdfl&#39;: False}</span>
<span class="sd">    {&#39;first&#39;: &#39;Vitalik&#39;, &#39;last&#39;: &#39;Buterin&#39;} --&gt; {&#39;yob&#39;: 1994, &#39;proj&#39;: &#39;ethereum&#39;, &#39;bdfl&#39;: True}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mgc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PyMongoCollectionSpec</span><span class="p">,</span> <span class="n">KvReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_write_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">iter_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ID</span><span class="p">,),</span>
        <span class="n">getitem_projection</span><span class="p">:</span> <span class="n">ProjectionSpec</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mgc</span><span class="o">=</span><span class="n">mgc</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="n">iter_projection</span><span class="o">=</span><span class="n">iter_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">mgc_find_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_write_filter</span> <span class="o">=</span> <span class="n">on_write_filter</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">Mapping</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;k (key) and v (value) must both be mappings (often dictionaries). Were:</span><span class="se">\n\t</span><span class="s1">k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\n\t</span><span class="s1">v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
            <span class="n">replacement</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_doc</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
            <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">Mapping</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;k (key) must be a mapping (most often a dictionary). Were:</span><span class="se">\n\t</span><span class="s1">k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_merge_with_filt</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You can&#39;t remove that key: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">Mapping</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; v (value) must be a mapping (often a dictionary). Were:</span><span class="se">\n\t</span><span class="s1">v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_doc</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; values must be mappings (often dictionaries)&#39;</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgc</span><span class="o">.</span><span class="n">insert_many</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_doc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_build_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">merge_doc_elements_with_filter</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_write_filter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">v</span><span class="p">,</span> <span class="n">Mapping</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; v (value) must be a mapping (often a dictionary). Were:</span><span class="se">\n\t</span><span class="s1">v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">merge_doc_elements_with_filter</span><span class="p">()</span>
        <span class="n">is_invalid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">x</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_invalid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The doc contains some query-specific values.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">persist_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">({</span><span class="n">ID</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">ID</span><span class="p">]},</span> <span class="n">data</span><span class="p">)</span></div>


<span class="c1"># class MongoAppendablePersister(MongoCollectionPersister):</span>
<span class="c1">#     &quot;&quot;&quot;MongoCollectionPersister endowed with an append and an extend that will write any dict (doc) to the collection</span>
<span class="c1">#     (as is, with no key-value validation)&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def append(self, v):</span>
<span class="c1">#         return self._mgc.insert_one(v)</span>
<span class="c1">#</span>
<span class="c1">#     def extend(self, items):</span>
<span class="c1">#         return self._mgc.insert_many(items)</span>


<div class="viewcode-block" id="MongoClientReader"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoClientReader">[docs]</a><span class="k">class</span> <span class="nc">MongoClientReader</span><span class="p">(</span><span class="n">KvReader</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">MongoClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mongo_client_kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="o">**</span><span class="n">mongo_client_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span><span class="o">.</span><span class="n">list_database_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MongoDbReader</span><span class="p">(</span>
            <span class="n">db_name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">mongo_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span>
        <span class="p">)</span>  <span class="c1"># or just wrap self._mongo_client[k]?</span></div>


<div class="viewcode-block" id="MongoDbReader"><a class="viewcode-back" href="../../module_docs/mongodol/base.html#mongodol.base.MongoDbReader">[docs]</a><span class="k">class</span> <span class="nc">MongoDbReader</span><span class="p">(</span><span class="n">KvReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db_name</span><span class="o">=</span><span class="n">DFLT_TEST_DB</span><span class="p">,</span>
        <span class="n">mk_collection_store</span><span class="o">=</span><span class="n">MongoCollectionReader</span><span class="p">,</span>
        <span class="n">mongo_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">mongo_client_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Base Mongo Db Reader. Keys are collection names and values are collection store instances.</span>

<span class="sd">        :param db_name: Name of db</span>
<span class="sd">        :param mk_collection_store: Function that is called on a key (collection name) to make the</span>
<span class="sd">            collection store instance.</span>
<span class="sd">            Use mk_collection_store to define what kind of collection stores you want to make.</span>
<span class="sd">            Will be called with only one unnamed argument; the collection name.</span>
<span class="sd">            Use custom classes here, and/or partials (curried functions) thereof, to fix any parameters you want to fix.</span>
<span class="sd">        :param mongo_client: MongoClient instance, kwargs to make it (MongoClient(**kwargs)), or callable to make it</span>
<span class="sd">        :param mongo_client_kwargs: **kwargs to make a MongoClient, that is used if mongo_client is callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mongo_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="o">**</span><span class="n">mongo_client_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mongo_client</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="o">**</span><span class="n">mongo_client</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span> <span class="o">=</span> <span class="n">mongo_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_name</span> <span class="o">=</span> <span class="n">db_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_client</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_store_cls</span> <span class="o">=</span> <span class="n">mk_collection_store</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_store_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">mongodol</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol.html">mongodol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/add_ons.html">mongodol.add_ons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/base.html">mongodol.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/constants.html">mongodol.constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/errors.html">mongodol.errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/recipes.html">mongodol.recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/scrap/old01.html">mongodol.scrap.old01</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/scrap/views_work.html">mongodol.scrap.views_work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/stores.html">mongodol.stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests.html">mongodol.tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/add_ons_test.html">mongodol.tests.add_ons_test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/base_test.html">mongodol.tests.base_test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/data.html">mongodol.tests.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/int_tests/base_int_test.html">mongodol.tests.int_tests.base_int_test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/int_tests/conftest.html">mongodol.tests.int_tests.conftest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/not_working.html">mongodol.tests.not_working</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/stores_test.html">mongodol.tests.stores_test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tests/util.html">mongodol.tests.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/tracking_methods.html">mongodol.tracking_methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/trans.html">mongodol.trans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/util.html">mongodol.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/mongodol/utils/werk_local.html">mongodol.utils.werk_local</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;NO COPYRIGHT.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>